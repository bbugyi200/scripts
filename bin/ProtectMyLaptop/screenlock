#!/bin/bash


if [[ -f ~/.config/PML.conf ]]; then
    CONFIG_PATH=~/.config/PML.conf
elif [[ -f ~/.PML.conf ]]; then
    CONFIG_PATH=~/.PML.cfg
else
    logger "$(basename $0): No PML.conf file exists!"
    exit 1
fi


read -d '' awkScript <<-'EOF'
BEGIN {
    FS="[:=]"
}
/\\[Motion\\]/{flag=1; next}
/\\[.*\\]/{flag=0}
{
    if (flag && $1==opt) {
        print $2
    }
}
EOF

motion_enabled="$(awk -v opt=motion_enabled "$awkScript" $CONFIG_PATH)"
motion_delay="$(awk -v opt=motion_delay "$awkScript" $CONFIG_PATH)"
motion_oldest="$(awk -v opt=motion_oldest "$awkScript" $CONFIG_PATH)"
motion_root_dir="$(awk -v opt=motion_root_dir "$awkScript" $CONFIG_PATH)"


if [[ "$motion_enabled" -ne 0 ]]; then
    cd "$motion_root_dir"
    textme "ProtectMyLaptop has been activated!" 2> /var/tmp/screenlock.log
fi

echo $$ > /tmp/lock.pid
trap 'rm /tmp/lock.pid' EXIT

(sleep -- "$motion_delay" && motion) &
PID=$!

scrot /tmp/screenshot.png
convert /tmp/screenshot.png -blur 0x5 /tmp/screenshotblur.png
i3lock -n -i /tmp/screenshotblur.png

kill $PID
pkill motion

if [[ "$motion_enabled" = true ]]; then
    touch -t $(date --date="$motion_oldest minutes ago" +%Y%m%d%H%M) /tmp/motionts
    find . -newer /tmp/motionts -type f -name "*.jpg" -delete
fi
