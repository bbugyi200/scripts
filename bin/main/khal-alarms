#!/bin/bash

if [[ "$1" == "-d" ]]; then
    PS4='$LINENO: '
    set -x; shift
fi

echo $$ > /tmp/khal-alarms.pid

get_next_time() { 
    echo $(khal list --notstarted --day-format '' now | head -n 1 |\
        awk -F'-[0-9][0-9]:[0-9]| ' '{ $2=""; print $0; }')
}

args="$(get_next_time)"
while [[ "$args" != "No events" ]]; do
    alarm "${args%% *}" "${args#* }"

    if [[ "$?" -ne 0 ]]; then
        break
    fi
    args="$(get_next_time)"
done
