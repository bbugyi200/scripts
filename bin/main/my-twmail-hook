#!/usr/bin/env python

# twmail hook script that is called for every mail.
#
# The environment variables available to a hook are:
#
# TWMAIL_DATE
# TWMAIL_MESSAGE_ID
# TWMAIL_FROM
# TWMAIL_TO
# TWMAIL_SUBJECT
# TWMAIL_BODY

import datetime as dt
import os
import subprocess

import gutils

#######################################################################################
#  gutils library: https://github.com/bbugyi200/scripts/tree/master/pymodules/gutils  #
#######################################################################################

log = gutils.logging.getEasyLogger(__name__)

START_OF_DAY = 6  # Hour that day starts


def get_utc_dt(dt_fmt):
    return dt.datetime.strptime(os.environ['TWMAIL_DATE'], dt_fmt).replace(tzinfo=dt.timezone.utc)


if os.environ['TWMAIL_FROM'] == 'bryanbugyi34@gmail.com':
    parser = gutils.ArgumentParser()
    args = parser.parse_args()

    with gutils.logging.context(log, debug=args.debug, verbose=args.verbose):
        # Log all TWMAIL environment variable values
        log.vdebug('Date: %s', os.environ['TWMAIL_DATE'])
        log.vdebug('Message_id: %s', os.environ['TWMAIL_MESSAGE_ID'])
        log.vdebug('From: %s', os.environ['TWMAIL_FROM'])
        log.vdebug('To: %s', os.environ['TWMAIL_TO'])
        log.vdebug('Subject: %s', os.environ['TWMAIL_SUBJECT'])
        log.vdebug('Body: %s', os.environ['TWMAIL_BODY'])

        split_subject = os.environ['TWMAIL_SUBJECT'].split(r'â€”\ ')
        if len(split_subject) == 2:
            twargs, description = split_subject
        else:
            twargs = ''
            description = split_subject[0]

        # Format twargs
        twargs = twargs.replace('\\', '')
        twargs = twargs.lower()
        twargs = twargs.split()

        # Format description
        description = description.strip()
        description = description.replace('\\', '')
        description = description.capitalize()

        # Send Notification
        notification_msg = 'Adding "{}" to Inbox.'.format(description)
        log.info(notification_msg)
        gutils.notify(notification_msg)

        log.debug('Description: %s', description)
        subprocess.call(['task', 'add', '+inbox', *twargs, description])

        try:
            utc_email_datetime = get_utc_dt(r'%Y-%m-%dT%H:%M:%S\+00:00')
        except ValueError:
            utc_email_datetime = get_utc_dt(r'%Y-%m-%dT%H:%M:%S-04:00')

        email_datetime = utc_email_datetime.astimezone(tz=None)
        email_date = email_datetime.date()

        today_datetime = dt.datetime.now() - dt.timedelta(hours=START_OF_DAY)
        today_date = today_datetime.date()

        if email_date < today_date:
            log.info('Task was not added to Inbox recently. Removing wait.')
            uuid = subprocess.check_output('task +LATEST uuids', shell=True).decode('utf-8')
            subprocess.call(['task', uuid, 'modify', 'due:due-1d', 'wait:due'])
