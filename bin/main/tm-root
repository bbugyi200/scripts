#!/usr/bin/env python

"""Displays root directory of tmux window (based on tmuxinator config)"""

import getpass
import subprocess as sp  # noqa: F401

import yaml

import gutils

#######################################################################################
#  gutils library: https://github.com/bbugyi200/scripts/tree/master/pymodules/gutils  #
#######################################################################################

log = gutils.logging.getEasyLogger(__name__)


def main():
    all_windows = get_all_windows(args.session_name)
    window_map = all_windows[args.window_name]
    rootdir = get_rootdir(args.session_name, window_map)
    print(rootdir, end='')


def get_all_windows(session_name):
    """Returns dictionary of all windows for the given @session_name."""
    mux_yaml_path = '/home/bryan/.config/tmuxinator/{}.yml'.format(session_name)
    with open(mux_yaml_path) as f:
        raw_dict = yaml.safe_load(f)

    D = dict()
    for window_dict in raw_dict['windows']:
        D.update(window_dict)

    return D


def get_rootdir(session_name, window_map):
    """Returns the final root directory path."""
    if 'root' in window_map:
        rootdir = window_map['root']
        rootdir = rootdir.replace('~', '/home/{}'.format(getpass.getuser()))
        return rootdir
    else:
        ps = sp.check_output(['tmdir', '--get', session_name])
        return ps.decode().strip()


if __name__ == "__main__":
    parser = gutils.ArgumentParser()
    parser.add_argument('session_name', help='Name of tmux session.')
    parser.add_argument('window_name', help='Name of the tmux window.')
    args = parser.parse_args()

    with gutils.logging.context(log, debug=args.debug):
        main()
