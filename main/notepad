#!/bin/zsh

open_notepad() {
	bspc node -p south -o 0.8
	termite --class="notepad" --title="notepad" -e "vim + $fpath"
}


eval set -- $(getopt -o "osp:" -l "open,side,put:" -- "$@")

while [[ -n "$1" ]]; do
	case $1 in
		'-o' | '--open' )
			action="open"
			;;
		'-s' | '--side' )
			action="side"
			;;
		'-p' | '--put' )
			shift
			case "$1" in
				'major' )
					action="put-major"
					;;
				'minor' )
					action="put-minor"
					;;
			esac
			;;
		'--' )
			shift
			break
			;;
	esac
	shift
done


base=$(basename $1)
base=${base// /_}
base=${base%pdf}
fpath="/home/bryan/Dropbox/notes/Study/${base}txt"


if [[ $action == "open" ]]; then
	open_notepad
elif [[ $action == "side" ]]; then
	termite --class="notepad" --title="notepad" -e "vim + $fpath"
elif [[ $action == "put"* ]]; then
	page=$(wmctrl -l | grep $base | tr -s ' ' | cut -d ' ' -f5 | cut -d'[' -f2 | cut -d'/' -f1 | head -1)
	clip=$(xclip -selection clipboard -o)
	if [[ $clip == *[a-z] ]]; then
		clip=${clip%[A-Z]*}
		clip="$(echo -e "${clip}" | sed -e 's/[[:space:]]*$//')"
	fi
	if [[ $action == "put-major" ]]; then
		printf "\n" >> $fpath
	elif [[ $action == "put-minor" ]]; then
		printf "  - " >> $fpath
		clip=$(echo -n $clip | sed ':a;N;$!ba;s/\n/\n     /g')
	fi
	printf "\"" >> $fpath
	echo -n $clip >> $fpath 
	printf "\" - p%s\n" $page >> $fpath
	wmctrl -c notepad && open_notepad && sleep 0.3 && wmctrl -ax zathura.Zathura
fi
