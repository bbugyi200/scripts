#!/usr/bin/env python

# twmail hook script that is called for every mail.
#
# The environment variables available to a hook are:
#
# TWMAIL_DATE
# TWMAIL_MESSAGE_ID
# TWMAIL_FROM
# TWMAIL_TO
# TWMAIL_SUBJECT
# TWMAIL_BODY

import datetime as dt
import os
import subprocess

import gutils

log = gutils.logging.getEasyLogger(__name__)

START_OF_DAY = 6  # Hour that day starts


if os.environ['TWMAIL_FROM'] == 'bryanbugyi34@gmail.com':
    parser = gutils.ArgumentParser()
    args = parser.parse_args()

    with gutils.logging.context(log, debug=args.debug):
        notification_msg = 'Adding "{}" to Inbox.'.format(os.environ['TWMAIL_SUBJECT'])
        log.info(notification_msg)
        gutils.subprocess.notify(notification_msg)
        subprocess.call('task add +inbox {}'.format(os.environ['TWMAIL_SUBJECT']), shell=True)

        utc_email_datetime = dt.datetime.strptime(os.environ['TWMAIL_DATE'], r'%Y-%m-%dT%H:%M:%S\+00:00').replace(tzinfo=dt.timezone.utc)
        email_datetime = utc_email_datetime.astimezone(tz=None)
        email_date = email_datetime.date()

        today_datetime = dt.datetime.now() - dt.timedelta(hours=START_OF_DAY)
        today_date = today_datetime.date()

        if email_date < today_date:
            log.info('Task was not added to Inbox recently. Removing wait.')
            uuid = subprocess.check_output('task +LATEST uuids', shell=True).decode('utf-8')
            subprocess.call(['task', uuid, 'modify', 'due:due-1d', 'wait:due'])
