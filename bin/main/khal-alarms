#!/bin/bash

PID_FILE=/tmp/khal-alarms.pid
FIFO=/tmp/calevent-fifo

[[ -p $FIFO ]] || mkfifo $FIFO

if [[ "$1" == "-d" ]]; then
    PS4='$LINENO: '
    set -x; shift
fi

print_event() {
    printf "\"$title\" at $starttime\n" > "$FIFO"
}

N=1
if [[ -f $PID_FILE ]]; then
    if kill -0 "$(cat $PID_FILE)" &> /dev/null; then
        cat $PID_FILE | xargs kill
    fi
fi

echo $$ > $PID_FILE

get_start_time() { 
    echo $(khal list --notstarted --day-format '' --format '{start-time}' now | head -n "$N" | tail -n 1)
}

get_title() { 
    echo $(khal list --notstarted --day-format '' --format '{title}' now | head -n "$N" | tail -n 1)
}

while [[ -z "$(get_start_time)" ]]; do
    N="$((N + 1))"
done

starttime="$(get_start_time)"
title="$(get_title)"

while [[ "$args" != "No"* ]]; do
    print_event
    alarm "$starttime" "$title"

    if [[ "$?" -ne 0 ]]; then
        break
    fi

    starttime="$(get_start_time)"
    title="$(get_title)"
done
