#!/bin/bash

#############################################
#  Initialize Script using Preset Template  #
#############################################

source /home/bryan/Dropbox/scripts/templates/gutils.sh

# ---------- Command-line Arguments ----------
eval set -- "$(getopt -o "d,D:,e,f:" -l "debug,bin-directory:,use-extension,filetype:" -- "$@")"

while [[ -n "$1" ]]; do
    case $1 in
       -d|--debug )
           PS4='$LINENO: '
           set -x
           ;;
       -D|--bin-directory )
           shift
           BIN_SUBDIR="$1"
           ;;
       -e|--use-extension )
           use_extension=true
           ;;
       -f|--filetype )
           shift
           FILETYPE="$1"
           ;;
       -- )
           shift
           break
           ;;
    esac
    shift
done

if [[ -z "$1" ]] || [[ -z "$FILETYPE" ]]; then
    die "usage: $(basename "$0") [-D BIN_SUBDIR] -f filetype SCRIPT_NAME" 2
fi

# ---------- Global Variables ----------
SCRIPT_NAME="$1"; shift
BIN="/home/bryan/Dropbox/scripts/bin"

# ---------- Main ----------
if [[ "$(pwd)" != "$BIN/"* ]] && [[ -z "$BIN_SUBDIR" ]]; then
    BIN_SUBDIR=main
fi

[ -d "$BIN"/"$BIN_SUBDIR" ] || die "The directory $BIN/$BIN_SUBDIR does NOT exist." 
cd "$BIN"/"$BIN_SUBDIR" || exit 1
emsg "Entering $BIN/$BIN_SUBDIR."

case "$FILETYPE" in
    python )
        EXT="py"
        ;;
    bash )
        EXT="sh"
        ;;
    awk )
        EXT="awk"
        ;;
    * )
        die "EXTENSION must be contained in: [py, sh, awk]"
esac

if [[ "$use_extension" = true ]]; then
    FULL_SCRIPT_NAME="${SCRIPT_NAME}.${EXT}"
else
    FULL_SCRIPT_NAME="${SCRIPT_NAME}"
fi

if ! [[ -f "$FULL_SCRIPT_NAME" ]]; then
    TEMPLATE="$(cat /home/bryan/Dropbox/scripts/templates/template."$EXT")\n"
    printf "$TEMPLATE" > "$FULL_SCRIPT_NAME"
    emsg "Initializing '$FULL_SCRIPT_NAME' script."
else
    emsg "The '$FULL_SCRIPT_NAME' script already exists."
fi

chmod +x "$FULL_SCRIPT_NAME"
clinks
vim +3 "$FULL_SCRIPT_NAME"
