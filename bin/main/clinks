#!/bin/bash

##################################
#  parse command-line arguments  #
##################################
if [[ -z "$1" ]]; then
    FLAG=-R
else
    FLAG=$1
fi

#######################
#  mkdirs for clinks  #
#######################
if [[ "$FLAG" != "-D" ]]; then
    find /home/bryan/Dropbox/dotfiles/home/.local/share -maxdepth 1 -type d -execdir mkdir -p /home/bryan/.local/share/{} ";" &> /dev/null
    find /home/bryan/Dropbox/dotfiles/home/.local/share -maxdepth 1 -type d -execdir mkdir -p /root/.local/share/{} ";" &> /dev/null

    # Directories inside /home/<user> that should be created before running clinks
    HOME_DIRS=(".gnupg" ".matlab" ".xmonad")

    for D in "${HOME_DIRS[@]}"; do
        mkdir /home/bryan/"$D" &> /dev/null
        mkdir /root/"$D" &> /dev/null
    done

fi

############################
#  ensure running as root  #
############################
if [ "$(id -u)" != "0" ]; then
  exec sudo "$0" "$@"
fi

ROOT_DUPLICATE_DIRS=(".ssh")
if [[ "$FLAG" != "-D" ]]; then
    for D in "${ROOT_DUPLICATE_DIRS[@]}"; do
        rm -rf /root/"$D"
    done
fi

##############################
#  use 'stow' to make links  #
##############################
if [[ $(hostname) == "athena" ]]; then
	stow --dir=/home/bryan/Dropbox/scripts/bin --target=/etc "$FLAG" cron.jobs
fi

##### SCRIPTS
stow --dir=/home/bryan/Dropbox/scripts/bin --target=/usr/local/bin "$FLAG" main
stow --dir=/home/bryan/Dropbox/scripts/bin --target=/usr/local/bin "$FLAG" awk
stow --dir=/home/bryan/Dropbox/scripts/bin --target=/usr/local/bin "$FLAG" xmonad
stow --dir=/home/bryan/Dropbox/scripts/bin --target=/usr/local/bin "$FLAG" ProtectMyLaptop
stow --dir=/home/bryan/Dropbox/scripts --target=/usr/local/python "$FLAG" pymodules

##### DOTFILES
stow --dir=/home/bryan/Dropbox/dotfiles --target=/home/bryan "$FLAG" home
stow --dir=/home/bryan/Dropbox/dotfiles --target=/root "$FLAG" home
stow --dir=/home/bryan/Dropbox/dotfiles --target=/etc "$FLAG" etc
stow --dir=/home/bryan/Dropbox/dotfiles --target=/usr "$FLAG" usr

##### C PROJECTS
stow --dir=/home/bryan/Dropbox/scripts/C --target=/usr/local/src "$FLAG" src
stow --dir=/home/bryan/Dropbox/scripts/C --target=/usr/local/include "$FLAG" include
stow --dir=/home/bryan/Dropbox/scripts/C --target=/usr/local/lib "$FLAG" lib

#####################
#  Cleanup Actions  #
#####################
if [[ "$FLAG" != "-D" ]]; then
    for D in "${ROOT_DUPLICATE_DIRS[@]}"; do
        rm -rf /root/"$D"
        mkdir -p /root/"$D"
        cp -rf /home/bryan/"$D"/* /root/"$D"
    done
fi
