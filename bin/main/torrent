#!/usr/bin/env python3

"""
Connects to a VPN, torrents a movie, disconnects from the VPN
when the download is finished, and then texts me.
"""

import argparse
import os
import time
import subprocess as sp
import sys

delay_help = "Delay starting the script for a few seconds. This is useful when\
        running the script over ssh because it gives you time to exit the session\
        normally before you lose the connection."

EXTENDED_TIME = 10800  # 3 hours
large_help = "Increases the amount of time before timeout occurs to {0:.1f} hours.\
         Useful when torrenting large files.".format(EXTENDED_TIME / 3600)

parser = argparse.ArgumentParser(description=__doc__)
parser.add_argument('magnet', help='The torrent magnet file.')
parser.add_argument('-D', '--delay', dest='delay', action='store_true', help=delay_help)
parser.add_argument('-L', '--large-download', dest='large', action='store_true', help=large_help)
args = parser.parse_args()

DEVNULL = open(os.devnull, 'w')
# DEVNULL = None


def textme(msg):
    """ Sends SMS Message to my Cell Phone """
    sp.call(['textme', msg], stdout=DEVNULL)


if args.delay:
    time.sleep(10)

if args.large:
    MAX_TIME = EXTENDED_TIME
else:
    MAX_TIME = 3600  # 1 hour


try:
    sp.check_call(['PIA', 'start', 'nyc'], stdout=DEVNULL)
    sp.check_call(['transmission-daemon'], stdout=DEVNULL)
except sp.CalledProcessError as e:
    textme('Failed to start the VPN and/or the transmission daemon! :(')
    sys.exit(1)
else:
    i = 0
    while True:
        time.sleep(1)
        try:
            sp.check_call(['transmission-remote', '-a', args.magnet], stdout=DEVNULL)
        except sp.CalledProcessError as e:
            i += 1
            if i <= 10:
                continue
            else:
                textme('Failed to start torrent! :(')
                raise
        else:
            break

    i = 0
    while True:
        SLEEP_TIME = 5

        i += 1
        if i > (MAX_TIME / SLEEP_TIME):
            msg = "Torrent is still attempting to download after {0:.1f} hour(s) elapsed time.\
                   Shutting down early! :(".format(MAX_TIME / 3600)
            textme(msg)
            sys.exit(1)

        time.sleep(SLEEP_TIME)

        p = sp.Popen(['transmission-remote', '-l'], stdout=sp.PIPE)
        output = p.communicate()[0].decode('utf-8')
        if 'finished' in output.lower():
            break

    textme('Your movie has finished downloading! :)')

finally:
    sp.call(['transmission-remote', '-t1', '-r'], stdout=DEVNULL)
    sp.call(['killall', '-9', 'transmission-daemon'], stdout=DEVNULL)
    sp.call(['PIA', 'stop'], stdout=DEVNULL)
