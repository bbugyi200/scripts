#!/bin/bash

read -r -d '' doc << EOM
Wrapper for Tmuxinator
EOM

source /home/bryan/Dropbox/scripts/modules/bash/gutils.sh

MUX_CONFIG_DIR=~/.config/tmuxinator
usage="${usage} [-d] [-h] [-MUX_OPTION [-MUX_OPTION [...]] | MUX_SESSION]"

if [[ "$1" == "-d" ]]; then
    PS4='$LINENO: '
    set -x
    shift
fi

if [[ "$1" == "-h" ]]; then
    printf "${doc}\n\n${usage}\n"
    exit 0
fi

if [[ -z "$1" ]]; then
    die "${usage}" 2
fi

case $1 in
    '-'* )
        CMD=${1#-}; shift
        if [[ 'edit' == "$CMD"* ]] && [[ -z "$1" ]]; then
            tmuxinator edit "$(tm-session-name)"
        else
            tmuxinator "$CMD" "$@"
        fi;;
    * )
        SESSION_NAME=$1; shift
        if [[ ! -f $MUX_CONFIG_DIR/$SESSION_NAME.yml ]]; then
            erb name="$SESSION_NAME" "$MUX_CONFIG_DIR"/default.yml > "$MUX_CONFIG_DIR"/"$SESSION_NAME".yml
        fi

        root="$(tm-session-root --get "$SESSION_NAME")"
        tmuxinator start "$SESSION_NAME" root="${root}"
        tmux switch-client -t "$SESSION_NAME";;
esac
