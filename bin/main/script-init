#!/bin/bash

#############################################
#  Initialize Script using Preset Template  #
#############################################

source /home/bryan/Dropbox/scripts/templates/gutils.sh

eval set -- "$(getopt -o "d,D:,e:" -l "debug,bin-directory:,extension:" -- "$@")"

while [[ -n "$1" ]]; do
    case $1 in
       -d|--debug )
           PS4='$LINENO: '
           set -x
           ;;
       -D|--bin-directory )
           shift
           BIN_SUBDIR="$1"
           ;;
       -e|--extension )
           shift
           EXT="$1"
           ;;
       -- )
           shift
           break
           ;;
    esac
    shift
done

if [[ -z "$1" ]] || [[ -z "$EXT" ]]; then
    die "usage: $(basename "$0") [-D BIN_SUBDIR] -e EXTENSION SCRIPT_NAME" 2
fi

SCRIPT_NAME="$1"; shift
BIN="/home/bryan/Dropbox/scripts/bin"

if [[ "$(pwd)" != "$BIN/"* ]] && [[ -z "$BIN_SUBDIR" ]]; then
    BIN_SUBDIR=main
fi

[ -d "$BIN"/"$BIN_SUBDIR" ] || die "The directory $BIN/$BIN_SUBDIR does NOT exist." 
cd "$BIN"/"$BIN_SUBDIR" || exit 1

case "$EXT" in
    py )
        ;;
    sh )
        ;;
    awk )
        use_extension=true
        ;;
    * )
        die "EXTENSION must be contained in: [py, sh, awk]"
esac

if [[ "$use_extension" = true ]]; then
    FULL_SCRIPT_NAME="${SCRIPT_NAME}.${EXT}"
else
    FULL_SCRIPT_NAME="${SCRIPT_NAME}"
fi

echo "Initializing $FULL_SCRIPT_NAME script into $BIN/$BIN_SUBDIR."
sleep 0.5

if [[ -z "$START_LINE" ]]; then
    START_LINE=3
elif [[ "$START_LINE" == "END" ]]; then
    START_LINE=
fi

if ! [[ -f "$FULL_SCRIPT_NAME" ]]; then
    TEMPLATE="$(cat /home/bryan/Dropbox/scripts/templates/template."$EXT")\n"
    printf "$TEMPLATE" > "$FULL_SCRIPT_NAME"
fi

chmod +x "$FULL_SCRIPT_NAME"
clinks
vim +"$START_LINE" "$FULL_SCRIPT_NAME"
