#!/bin/bash

####################################################
#  Wrapper for `emerge` that Deletes a Package(s)  #
####################################################
source /home/bryan/Dropbox/scripts/modules/bash/gutils.sh

# ---------- Command-line Arguments  ----------
eval set -- "$(getopt -o "d,D" -l "debug,depclean" -- "$@")"

while [[ -n "$1" ]]; do
    case $1 in
       -d|--debug )
           PS4='$LINENO: '
           set -x;;
       -D|--depclean )
           depclean=true
           ;;
       -- )
           shift
           break;;
    esac
    shift
done

# ---------- Main ----------
if [[ "$depclean" = true ]]; then
    OPTS=("--depclean" "--verbose")
else
    OPTS=("--unmerge")
fi

if sudo emerge --ask "${OPTS[@]}" "$@"; then
    all_sets=( "shared" "$(hostname)" )
    for pkg in "$@"; do
        for set in "${all_sets[@]}"; do
            filename=/etc/portage/sets/"${set}"
            if grep "${pkg}" "${filename}" &> /dev/null; then
                imsg "Purging ${pkg} from @${set}."
                sed -i "\|$(ecat "$pkg")/$pkg|d" "${filename}"
            fi
        done
    done

    imsg "Calling updatedb to update its databases."
    updatedb
else
    exit "$?"
fi
