#!/usr/bin/env python

""" Zathura Helper Script. Used to Search for and then Open Documents in Zathura. """

import os
import signal
import subprocess as sp

import gutils

log = gutils.logging.getEasyLogger(__name__)
CACHE_FILE = '{}/recently-opened.txt'.format(gutils.xdg.getdir('data'))


def main():
    try:
        open_docs = gutils.subprocess.shell('wmctrl -lx | grep zathura | tr -s " " | cut -d\' \' -f5- | grep -o ".*\\.\\(pdf\\|djvu\\|epub\\)"', cast=lambda x: x.split('\n'))
        log.debug('Open Docs: {}'.format(' '.join(open_docs)))
    except sp.CalledProcessError as e:
        open_docs = None
        log.debug('No documents are currently open in zathura.')

    all_docs = gutils.subprocess.shell('find /home/bryan/Dropbox /home/bryan/Downloads -name "*.pdf" -o -name "*.epub" -o -name "*.djvu" -o -name "*.ps"')
    cached_docs = gutils.subprocess.shell('cat {}'.format(CACHE_FILE))
    ordered_docs = promote_cached_docs(all_docs.split('\n'), cached_docs.split('\n'))

    if open_docs:
        ordered_docs = purge_open_docs(ordered_docs, open_docs)

    doc_options = '\n'.join(ordered_docs)
    choice = gutils.subprocess.shell('printf "{}" | rofi -p "Document" -m -4 -dmenu -i'.format(doc_options))

    add_to_cache(choice)

    if gutils.subprocess.shell('active_window_class') == 'Zathura':
        pid = gutils.subprocess.shell('active_window_pid', cast=int)
        log.debug('Killing Zathura Instance: {}'.format(pid))
        os.kill(pid, signal.SIGTERM)

    log.debug('Opening {} in zathura...'.format(choice))
    sp.Popen(['zathura', choice], stdout=sp.DEVNULL, stderr=sp.STDOUT)


def promote_cached_docs(docs, cached_docs):
    """ Docs in Cache File are Brought to the Top of the List of Options """
    D = docs[:]
    for c in list(reversed(cached_docs)):
        if c in D:
            D.remove(c)
            D.insert(0, c)
    return D


def purge_open_docs(docs, open_docs):
    """ Open Docs are Removed from the List of Options """
    D = docs[:]
    for odoc in open_docs:
        for doc in docs:
            if odoc in doc:
                D.remove(doc)
    return D


def add_to_cache(doc):
    """ Adds/moves doc to the Top of the Cache File """
    log.debug('Adding {} to cache file...'.format(doc))
    if os.path.isfile(CACHE_FILE):
        with open(CACHE_FILE, 'r') as f:
            cached_docs = f.read().strip().split('\n')

        if doc in cached_docs:
            cached_docs.remove(doc)

        cached_docs.insert(0, doc)

        with open(CACHE_FILE, 'w') as f:
            f.write('\n'.join(cached_docs[:100]))
    else:
        with open(CACHE_FILE, 'w') as f:
            f.write(doc)


if __name__ == "__main__":
    parser = gutils.ArgumentParser()
    args = parser.parse_args()

    with gutils.logging.context(log, debug=args.debug):
        main()
