#!/usr/bin/env python

"""Ebuild Version Check for Portage Overlay (uses 'app-portage/euscan')"""

import os
import subprocess as sp  # noqa: F401
import re

import gutils

#######################################################################################
#  gutils library: https://github.com/bbugyi200/scripts/tree/master/pymodules/gutils  #
#######################################################################################

log = gutils.logging.getEasyLogger(__name__)


def main():
    all_files = get_all_files(args.overlay_dir)
    all_ebuilds = [f for f in all_files if f.endswith('.ebuild')]

    all_pkgs = []
    for ebuild in all_ebuilds:
        filename = os.path.basename(ebuild)
        all_pkgs.append(re.sub('-([0-9])+\..*ebuild$', '', filename))

    log.debug('All Packages: %s', all_pkgs)
    log.debug('Number of packages: %s', len(all_pkgs))

    msg_fmt = '{}:: {}'

    for pkg in sorted(all_pkgs):
        ps = sp.check_output(['euscan', pkg])
        out = ps.decode().strip()
        log.debug('Euscan Output: %s', out)

        out_list = out.split('\n')

        fail_marker = 'Upstream Version: '
        pass_marker = "Didn't find any new version"
        for line in out_list:
            if fail_marker in line:
                fail_msg_fmt = msg_fmt.format(pkg, 'FAILED  (New Version: {})')
                print(fail_msg_fmt.format(line.replace(fail_marker, '')))
                break
            if pass_marker in line:
                print(msg_fmt.format(pkg, 'PASSED'))
                break
        else:
            print(msg_fmt.format(pkg, 'UNKNOWN'))


def get_all_files(dir):
    F = []
    for root, dirs, files in os.walk(dir):
        for name in files:
            F.append(os.path.join(root, name))
    return F


if __name__ == "__main__":
    parser = gutils.ArgumentParser()
    parser.add_argument('-D', dest='overlay_dir', default='/usr/local/portage',
                        help='Location (directory) of the portage overlay.')
    args = parser.parse_args()

    with gutils.logging.context(log, debug=args.debug, verbose=args.verbose):
        main()
