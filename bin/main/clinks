#!/bin/bash

##################################
#  parse command-line arguments  #
##################################
if [[ -z "$1" ]]; then
    FLAG=-R
else
    FLAG=$1
fi

#######################
#  mkdirs for clinks  #
#######################
if [[ "$FLAG" != "-D" ]]; then
    find /home/bryan/Dropbox/dotfiles/home/.local/share -maxdepth 1 -type d -execdir mkdir -p /home/bryan/.local/share/{} ";" &> /dev/null
    find /home/bryan/Dropbox/dotfiles/home/.local/share -maxdepth 1 -type d -execdir mkdir -p /root/.local/share/{} ";" &> /dev/null

    # Directories inside /home/<user> that should be created before running clinks
    HOME_DIRS=(".gnupg" ".matlab" ".xmonad" ".ssh")

    for D in "${HOME_DIRS[@]}"; do
        mkdir /home/bryan/"$D" &> /dev/null
        sudo mkdir /root/"$D" &> /dev/null
    done

fi

############################
#  ensure running as root  #
############################
if [ "$(id -u)" != "0" ]; then
  exec sudo "$0" "$@"
fi

##########################################
#  ROOT_DUPLICATE_DIRS Pre-stow Actions  #
##########################################
# The directories listed in ROOT_DUPLICATE_DIRS will be removed from the /root folder before
# running stow commands and then a recursive copy is made from /home/bryan/<DIR> to /root/<DIR>
# after the stow commands have concluded.
ROOT_DUPLICATE_DIRS=(".ssh")
if [[ "$FLAG" != "-D" ]]; then
    for D in "${ROOT_DUPLICATE_DIRS[@]}"; do
        rm -rf /root/"$D"
    done
fi

##############################
#  use 'stow' to make links  #
##############################
if [[ $(hostname) == "athena" ]]; then
	stow --dir=/home/bryan/Dropbox/scripts/bin --target=/etc "$FLAG" cron.jobs
fi

##### SCRIPTS
stow --dir=/home/bryan/Dropbox/scripts/bin --target=/usr/local/bin "$FLAG" awk
stow --dir=/home/bryan/Dropbox/scripts/bin --target=/usr/local/bin "$FLAG" main
stow --dir=/home/bryan/Dropbox/scripts/bin --target=/usr/local/bin "$FLAG" maintenance
stow --dir=/home/bryan/Dropbox/scripts/bin --target=/usr/local/bin "$FLAG" xmonad
stow --dir=/home/bryan/Dropbox/scripts/bin --target=/usr/local/bin "$FLAG" ProtectMyLaptop

##### MODULES / LIBRARIES / HEADERS
stow --dir=/home/bryan/Dropbox/scripts --target=/usr/local/python "$FLAG" pymodules
stow --dir=/home/bryan/Dropbox/scripts/C --target=/usr/local/src "$FLAG" src
stow --dir=/home/bryan/Dropbox/scripts/C --target=/usr/local/include "$FLAG" include
stow --dir=/home/bryan/Dropbox/scripts/C --target=/usr/local/lib "$FLAG" lib

##### DOTFILES
stow --dir=/home/bryan/Dropbox/dotfiles --target=/home/bryan "$FLAG" home
stow --dir=/home/bryan/Dropbox/dotfiles --target=/root "$FLAG" home
stow --dir=/home/bryan/Dropbox/dotfiles --target=/usr "$FLAG" usr

###########################################
#  ROOT_DUPLICATE_DIRS Post-stow Actions  #
###########################################
if [[ "$FLAG" != "-D" ]]; then
    for D in "${ROOT_DUPLICATE_DIRS[@]}"; do
        rm -rf /root/"$D"
        mkdir -p /root/"$D"
        cp -rf /home/bryan/"$D"/* /root/"$D"
    done
fi
