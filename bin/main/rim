#!/usr/bin/env python

""" Utility script to open recent files. """

import getpass
import re
import subprocess as sp  # noqa: F401

import gutils

#######################################################################################
#  gutils library: https://github.com/bbugyi200/scripts/tree/master/pymodules/gutils  #
#######################################################################################

log = gutils.logging.getEasyLogger(__name__)
user = getpass.getuser()


if __name__ == "__main__":
    parser = gutils.ArgumentParser()
    parser.add_argument('subfname', help='A substring contained in the desired filename.')
    args = parser.parse_args()

    with gutils.logging.context(log, debug=args.debug):
        target_file = None
        for line in open('/home/{}/.vim/viminfo'.format(user), 'rb'):
            try:
                line = line.decode()
            except UnicodeDecodeError:
                continue

            match = re.search('^> (.*/[^/]*{}[^/]*$)'.format(args.subfname), line)
            if match:
                target_file = match.groups()[0].strip()

        if target_file is None:
            raise RuntimeError('Unable to find recent file containing "{}"'.format(args.subfname))

        target_file = target_file.replace('~', '/home/{}'.format(user))
        log.debug('Target File: {}'.format(target_file))
        sp.check_call(['vim', target_file])
