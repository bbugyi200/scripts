#!/bin/bash

############################
#  Initialize Bash Script  #
############################

source /home/bryan/Dropbox/scripts/templates/gutils.sh

eval set -- "$(getopt -o "d,D:,f:" -l "debug,bin-directory:,filetype" -- "$@")"

while [[ -n "$1" ]]; do
    case $1 in
       -d|--debug )
           PS4='$LINENO: '
           set -x
           ;;
       -D|--bin-directory )
           shift
           BIN_SUBDIR="$1"
           ;;
       -f|--filetype )
           shift
           FILETYPE="$1"
           ;;
       -- )
           shift
           break
           ;;
    esac
    shift
done

if [[ -z "$1" ]] || [[ -z "$FILETYPE" ]]; then
    die "usage: $(basename "$0") [-D BIN_SUBDIR] -f FILETYPE SCRIPT_NAME" 2
fi

SCRIPT_NAME="$1"; shift
BIN="/home/bryan/Dropbox/scripts/bin"

if [[ "$(pwd)" != "$BIN/"* ]] && [[ -z "$BIN_SUBDIR" ]]; then
    cd "$BIN"/main || exit 1
    echo "Initializing $SCRIPT_NAME bash script into $BIN/main."
    sleep 0.5
fi

if [[ -n "$BIN_SUBDIR" ]]; then
    [ -d "$BIN"/"$BIN_SUBDIR" ] || die "The directory $BIN/$BIN_SUBDIR does NOT exist." 
    cd "$BIN"/"$BIN_SUBDIR" || exit 1
    echo "Initializing $SCRIPT_NAME bash script into $BIN/$BIN_SUBDIR."
    sleep 0.5
fi

case "$FILETYPE" in
    python )
        TEMPLATE="$(cat /home/bryan/Dropbox/scripts/templates/template.py)\n"
        ;;
    bash )
        START_LINE=3
        read -r -d '' TEMPLATE << EOM
#!/bin/bash

box

source /home/bryan/Dropbox/scripts/templates/gutils.sh
EOM
        ;;
    awk )
        EXT="awk"
        read -r -d '' TEMPLATE << EOM
#!/bin/awk
EOM
        ;;
    * )
        die "FILETYPE must be contained in: [python, bash, awk]"
esac

if [[ -n "$EXT" ]]; then
    EXT=".$EXT"
fi

if [[ -z "$START_LINE" ]]; then
    START_LINE=1
elif [[ "$START_LINE" == "END" ]]; then
    START_LINE=
fi

FULL_SCRIPT_NAME="${SCRIPT_NAME}${EXT}"

if ! [[ -f "$FULL_SCRIPT_NAME" ]]; then
    printf "$TEMPLATE" > "$FULL_SCRIPT_NAME"
fi

chmod +x "$FULL_SCRIPT_NAME"
clinks 
vim +"$START_LINE" "$FULL_SCRIPT_NAME"
