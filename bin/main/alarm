#!/bin/bash

# My Colors
GREEN="#0BF816"
YELLOW="#EBEE27"
RED="#FB0611"
BLUE="#3C4BF7"
WHITE="#FFFFFF"
GREY="#D9D9D9"


PID_FILE=/tmp/alarm.pid
TIMESTAMP_FILE=/home/bryan/.alarm.ts
FIFO=/tmp/counter-fifo


time_left() {
	echo $(($stop_time - $(date --date="now" +%s)))
}


# ---------- Command Line Arguments ----------
eval set -- $(getopt -o "d,r" -l "debug,resume" -- "$@")

while [[ -n "$1" ]]; do
	case $1 in
        -d|--debug )
            PS4='$LINENO: '
            set -x;;
        -r|--resume )
            resume=true;;
		-- )
			shift
			break;;
	esac
	shift
done


if [[ "$resume" = true && ! -f $TIMESTAMP_FILE ]]; then
    exit 1
fi


[[ -p $FIFO ]] || mkfifo $FIFO


# ---------- Another Alarm is Already Running ----------
# I am not sure why '-ge 3' instead of '-ge 2' but it is correct
# Maybe because pgrep counts itself?
if [[ -f $PID_FILE ]] || [[ "$(pgrep $(basename $0) | wc -l)" -ge 3 ]]; then
    if [[ "$resume" = true ]]; then
        echo "No need to restart! An alarm is already running!" | tee >(logger -t "$(basename $0)")
        exit 2
    fi

    echo "An alarm is already running! Stopping existing alarm!" | tee >(logger -t "$(basename $0)")

    if [[ -f $PID_FILE ]]; then
        cat $PID_FILE | xargs kill
    else
        pgrep "$(basename $0)" | grep -v $$ | xargs kill
    fi

    rm $TIMESTAMP_FILE
	printf "\n" > "$FIFO"
    if pgrep dunst; then
        sleep 0.5
        xdotool key ctrl+space  # Shortcut to close dunst notification
    fi
	exit 0
fi


echo $$ > $PID_FILE
trap 'rm $PID_FILE' EXIT
trap ':' SIGPIPE


# ---------- Set Alarm Time ----------
if [[ -f $TIMESTAMP_FILE ]]; then
    stop_time=$(cat $TIMESTAMP_FILE)
else
    if [[ -z "$1" ]]; then
        alrm_time="$(echo | dmenu -p "Alarm:")"
    else
        alrm_time=$1
    fi

    if [[ -z "$alrm_time" ]]; then
        exit 1
    fi


    if [[ $alrm_time == *"s" ]]; then
        stop_time=$(date --date="${alrm_time%s} seconds" +%s)
    elif [[ $alrm_time == *":"* ]]; then
        stop_time=$(date --date="$alrm_time" +%s)
        if [[ $(date +%s) -ge $stop_time ]]; then
            stop_time=$(date --date="$alrm_time tomorrow" +%s)
        fi
    else
        stop_time=$(date --date="$alrm_time minutes" +%s)
    fi

    echo $stop_time > $TIMESTAMP_FILE
fi


# ---------- Main Output ----------
iclock="<icon=clock.xbm/>"
while true; do
	TL=$(time_left)
	if [[ $TL -ge 3600 ]]; then
		printf "<fc=$GREY>  %d:%02d:%02d$iclock</fc>  |  \n" $((TL/3600)) $((TL%3600/60)) $((TL%3600%60))
	else
		printf "<fc=$GREY>  %d:%02d$iclock</fc>  |  \n" $((TL/60)) $((TL%60))
	fi
	sleep 1

	if [[ $TL -le 0 ]]; then
		break;
	fi
done > "$FIFO"


# ---------- Timer Finished ----------
notify-send -u critical -i /usr/share/icons/gnome/16x16/status/appointment-soon.png "$(basename $0)" "THE TIMER IS DONE!"

printf "\n" > "$FIFO"

rm $TIMESTAMP_FILE
