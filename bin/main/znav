#!/bin/bash

#################################################
#  Zathura Utility Script for better Navigation #
#################################################

eval set -- "$(getopt -o "b:,d,D,I:,O:,U" -l "blist:,debug,down,in:,out:,up" -- "$@")"

while [[ -n "$1" ]]; do
    case $1 in
        -b|--blist )
            shift
            BMARK="$1"
            ;;
       -d|--debug )
           PS4='$LINENO: '
           set -x
           ;;
       -D|--down )
           DIRECTION="down"
           OTHER_DIRECTION="up"

           KEYS=JH
           SCROLL_KEY=L
           ;;
       -I|--in )
           shift
           KEYS="$1"
           ZOOM="in"
           ;;
       -O|--out )
           shift
           KEYS="$1"
           ZOOM="out"
           ;;
       -U|--up )
           DIRECTION="up"
           OTHER_DIRECTION="down"

           KEYS=KL
           SCROLL_KEY=H
           ;;
       -- )
           shift
           break
           ;;
    esac
    shift
done

DOCUMENT_TITLE="$(ztitle)"

if [[ -z "$DOCUMENT_TITLE" ]]; then
    echo "No Zathura Document is Focused" | tee >(logger -t "$(basename "$0")")
    exit 1
fi

if [[ -n "$XDG_DATA_HOME" ]]; then
    _xdg_data_home="$XDG_DATA_HOME"
else
    _xdg_data_home="$HOME"/.local/share
fi

D="$_xdg_data_home"/"$(basename "$0")"/documents/"$DOCUMENT_TITLE"
[ -d "$D" ] || mkdir -p "$D"

if [[ -z "$DIRECTION" ]] && [[ -z "$ZOOM" ]] && [[ -z "$BMARK" ]]; then
    echo "usage: $(basename "$0") [-U | -D | -I KEYS | -O KEYS]"
    exit 2
fi

PAGE_FIT_MARKER="$D"/page-fit
if [[ -n "$BMARK" ]]; then
    FP_LAST_DOT="$D"/last_dot

    if [[ "$BMARK" == "." ]]; then
        if ! [ -f "$FP_LAST_DOT" ]; then
            echo "ERROR: Double-dot Page Not Set." | tee >(logger -t "$(basename "$0")")
            exit 1
        fi

        LAST_DOT_PAGE="$(cat "$FP_LAST_DOT")"

        if ! [[ "$LAST_DOT_PAGE" =~ [0-9]+ ]]; then
            echo "ERROR: Double-dot Page Must be Numeric." | tee >(logger -t "$(basename "$0")")
            exit 1
        fi

        KEYS=":$LAST_DOT_PAGE"
        send_enter=true
    else
        KEYS="g$BMARK"
    fi

    CURRENT_PAGE="$(zpage)"
    echo "$CURRENT_PAGE" > "$FP_LAST_DOT"
elif [[ -n "$DIRECTION" ]]; then
    if [[ -f "$PAGE_FIT_MARKER" ]]; then
        [ -f "$D"/"$DIRECTION" ] && rm "$D"/"$DIRECTION"
        [ -f "$D"/"$OTHER_DIRECTION" ] && rm "$D"/"$OTHER_DIRECTION"
    elif [[ -f "$D"/"$DIRECTION" ]]; then
        rm "$D"/"$DIRECTION"
        touch "$D"/"$OTHER_DIRECTION"
    else
        KEYS="$SCROLL_KEY"
        touch "$D"/"$DIRECTION"
        [ -f "$D"/"$OTHER_DIRECTION" ] && rm "$D"/"$OTHER_DIRECTION"
    fi
elif [[ -n "$ZOOM" ]]; then
    case "$ZOOM" in
        "out" )
            touch "$PAGE_FIT_MARKER"
            ;;
        "in" )
            rm "$PAGE_FIT_MARKER"
            [ -f "$D"/up ] && rm "$D"/up
            [ -f "$D"/down ] && rm "$D"/down
            ;;
    esac
fi

xtype "$KEYS"

if [[ "$send_enter" = true ]]; then
    xdotool key Return
fi
