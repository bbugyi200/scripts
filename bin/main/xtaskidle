#!/usr/bin/env python

""" Stops Current TaskWarrior Task if Machine Idles for Too Long """

import argparse
import os
import time
import subprocess as sp

max_help = 'max amount of idletime (in minutes) to allow before stopping task'
delay_help = 'time (in seconds) to delay between calls to xprintidle'
MILLISECONDS_IN_MINUTE = 60000
DEVNULL = open(os.devnull, 'w')


def xprintidle():
    """ Returns Machine's Current Idletime """
    out = sp.check_output(['xprintidle'])
    return int(out.decode())


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description=__doc__)
    parser.add_argument('max_idle', type=float, help=max_help)
    parser.add_argument('-D', '--delay', dest='delay', nargs='?', type=int, default=30, help=delay_help)
    args = parser.parse_args()

    MAX_IDLE = args.max_idle * MILLISECONDS_IN_MINUTE

    while True:
        if xprintidle() >= MAX_IDLE:
            try:
                sp.check_call(['task', 'start.any:', 'stop'], stdout=DEVNULL, stderr=DEVNULL)
            except sp.CalledProcessError as e:
                time.sleep(args.delay*2)
                continue
        else:
            time.sleep(args.delay)
            continue

        while True:
            time.sleep(1)
            if xprintidle() <= MAX_IDLE:
                sp.call(['last_task'], stdout=DEVNULL, stderr=DEVNULL)
                break
