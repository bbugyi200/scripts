#!/bin/bash

#################################################
#  Initialize Script using Predefined Template  #
#################################################

source /home/bryan/Dropbox/scripts/modules/bash/gutils.sh

# ---------- Command-line Arguments ----------
eval set -- "$(getopt -o "d,D:,f,F:,h,N,x" -l "debug,bin-directory:,filetype:,help,not-executable,use-extension" -- "$@")"

USAGE="usage: $(basename "$0") [-d] [-h] [-D BIN_SUBDIR] [-f] [-N] [-x] -F FILETYPE SCRIPT_NAME"
executable=true

read -r -d '' HELP << EOM
$USAGE
EOM

while [[ -n "$1" ]]; do
    case $1 in
       -d|--debug )
           PS4='$LINENO: '
           set -x
           ;;
       -h|--help )
           echo "$HELP"
           exit 0
           ;;
       -D|--bin-directory )
           shift
           BIN_SUBDIR="$1"
           ;;
       -f )
           force=true
           ;;
       -F|--filetype )
           shift
           FILETYPE="$1"
           ;;
       -N|--not-executable )
           executable=false
           ;;
       -x|--use-extension )
           use_extension=true
           ;;
       -- )
           shift
           break
           ;;
    esac
    shift
done

if [[ -z "$1" ]] || [[ -z "$FILETYPE" ]]; then
    die "$USAGE" 2
fi

# ---------- Global Variables ----------
SCRIPT_NAME="$1"; shift
BIN="/home/bryan/Dropbox/scripts/bin"

# ---------- Main ----------
if [[ "$(pwd)" == "$BIN/"* && -z "$BIN_SUBDIR" ]] || [[ "$force" = true ]]; then
    FULL_BIN_PATH="$(pwd)"
elif [[ -z "$BIN_SUBDIR" ]]; then
    FULL_BIN_PATH="$BIN"/main
else
    FULL_BIN_PATH="$BIN"/"$BIN_SUBDIR"
fi

if [[ "$(pwd)" != "$FULL_BIN_PATH" ]]; then
    [ -d "$FULL_BIN_PATH" ] || die "The directory $FULL_BIN_PATH does NOT exist." 
    cd "$FULL_BIN_PATH" || exit 1
    imsg "Entering $FULL_BIN_PATH."
fi

case "$FILETYPE" in
    awk )
        EXT="awk"
        ;;
    bash )
        EXT="sh"
        ;;
    latex )
        EXT="tex"
        ;;
    python )
        EXT="py"
        ;;
    * )
        die "FILETYPE must be contained in: [python, bash, awk]"
esac

if [[ "$use_extension" = true ]]; then
    FULL_SCRIPT_NAME="${SCRIPT_NAME}.${EXT}"
else
    FULL_SCRIPT_NAME="${SCRIPT_NAME}"
fi

if ! [[ -f "$FULL_SCRIPT_NAME" ]]; then
    cp /home/bryan/Dropbox/scripts/templates/template."${EXT}" "${FULL_SCRIPT_NAME}"
    imsg "Initializing the '$FULL_SCRIPT_NAME' script."
else
    imsg "The '$FULL_SCRIPT_NAME' script already exists."
fi

if [[ "${executable}" = true ]]; then
    chmod +x "$FULL_SCRIPT_NAME"
    clinks
fi

imsg "Editing the '$FULL_SCRIPT_NAME' script in vim."
vim +3 "$FULL_SCRIPT_NAME"

