#!/usr/bin/env python

""" Refresh window contents of the GTD tmux session """

import argparse
import subprocess as sp

mode_help = "Determines what information is refreshed. (Defaults to 'main')."
switch_help = "Switch to primary GTD window when done refreshing windows."
mode_opts = ['full', 'main', 'context']


class Win:
    """ Tmux Window Numbers """
    MAIN = 0
    TIMEW = 1
    KHAL = 2
    CONFIG = 3


def tmux_cmd(cmd, window, cmd_args=None, *, pane=0):
    """ Run Pre-formatted 'tmux <cmd>' Command """
    subprocess_command = ['tmux', '-L', 'GTD', cmd, '-t', 'GTD:{0}.{1}'.format(window, pane)]
    if cmd_args is not None:
        if isinstance(cmd_args, str):
            cmd_args = (cmd_args,)
        for arg in cmd_args:
            subprocess_command.append(arg)
    sp.call(subprocess_command)


def send_keys(window, keys, *, pane=0):
    """ Run Pre-formatted 'tmux send-keys' Command """
    tmux_cmd('send-keys', window, (keys, 'Enter'), pane=pane)


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description=__doc__)
    parser.add_argument('-m', '--mode', dest='mode', choices=mode_opts, default='main', help=mode_help)
    parser.add_argument('-s', '--switch', dest='switch', action='store_true', help=switch_help)
    args = parser.parse_args()

    if args.mode in ['full', 'context']:
        out = sp.check_output(['task', 'context', 'show']).decode('utf-8')
        if out.startswith('No'):
            current_context = 'NONE'
        else:
            temp = out.split()[1]
            current_context = temp.strip("'").upper()

        tmux_cmd('rename-window', Win.MAIN, current_context)
        send_keys(Win.CONFIG, ':e')

    if args.mode in ['full', 'main']:
        send_keys(Win.MAIN, 'clear' if args.switch else 'tc', pane=(1 if args.switch else 0))
        send_keys(Win.TIMEW, 'twc')
        send_keys(Win.KHAL, 'kc')

    if args.switch:
        tmux_cmd('select-window', Win.MAIN)
