#!/bin/zsh

eval set -- $(getopt -o "odusNp:" -l "open,debug,undo,side,no-newlines,put:,dmenu" -- "$@")

newlines=1
debug=0
dmenu=0
while [[ -n "$1" ]]; do
	case $1 in
		'-o' | '--open' )
			action="open";;
		'-d' | '--debug' )
			debug=1;;
		'-u' | '--undo' )
			action="undo";;
		'-s' | '--side' )
			action="side";;
		'-N' | '--no-newlines' )
			newlines=0;;
		'-p' | '--put' )
			shift
			case "$1" in
				'major' )
					action="put-major";;
				'minor' )
					action="put-minor";;
			esac;;
		'--dmenu' )
			dmenu=1;;
		'--' )
			shift
			break;;
	esac
	shift
done

tmux_send_keys() {
	if tmux send-keys -t notepad:0.0 ":e" Enter "G"; then
		:
	else
		tmux send-keys -t $abbrv:0.0 ":e" Enter "G"
	fi
}


base=$(basename $1)
base=${base// /_}
base=${base%.pdf}

abbrv=$(echo $base | sed -e 's/\([A-Z]\)[A-Z]*/\1/g; s/[a-z \.\_-]//g; s/(.*)//g')
fpath="/home/bryan/Dropbox/notes/Study/${base}.txt"
esc_fpath=$(printf "%q" $fpath)

if [[ $debug -eq 0 ]]; then
	exec 2>&1
	exec 1> /dev/null
fi

case $action in
	'open')
		bspc node -p south -o 0.8
		termite --title="notepad" --class="notepad" -e "tm-init notepad" &
		sleep 0.5
		tmux send-keys -t notepad:0.0 "vim + $esc_fpath" Enter;;
	'undo')
		sed -i'.backup' ':a; ${d; q}; N; /\n$/!ba' $fpath
		sed -i '$d' $fpath
		tmux_send_keys;;
	'side')
		tmux send-keys -t $abbrv:0.0 "vim + -c'?---' $esc_fpath" Enter "zt"
		wmctrl -a termite;;
	'put'*)
		page=$(wmctrl -l | grep $base | tr -s ' ' | cut -d ' ' -f5 | cut -d'[' -f2 | cut -d'/' -f1 | head -1)

		if [[ $dmenu -eq 0 ]]; then
			clip=$(xclip -selection clipboard -o)
			Q="\""

			if [[ $newlines -eq 0 ]]; then
				clip=$(echo $clip | tr '\n' ' ')
				if [[ $clip == [a-z]* ]]; then
					clip=${clip#*. }
				fi
			elif [[ $clip == *[A-Z]*"."* ]]; then
				if [[ $clip == *[A-Za-z,] ]]; then
					clip="${clip%.*}."
				fi
			fi
		else
			clip=$(echo | dmenu -p "notepad:")
			Q=
		fi

		if [[ -z "$clip" ]]; then
			logger "notepad: 'clip' variable is empty"
			exit 1
		fi

		if [[ $action == "put-major" ]]; then
			printf "\n" >> $fpath
		elif [[ $action == "put-minor" ]]; then
			printf "  * " >> $fpath
			clip=$(echo -n $clip | sed ':a;N;$!ba;s/\n/\n     /g')
		fi

		printf "$Q" >> $fpath
		echo -n $clip >> $fpath 
		printf "$Q - p%s\n" $page >> $fpath
		
		tmux_send_keys
		;;
esac
