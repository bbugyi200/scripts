#!/usr/bin/env python

"""Sets Event with khal using RELATIVE Time (x minutes from now)"""

import datetime as dt
import subprocess as sp
import sys  # noqa: F401

import gutils

############################################################################################
#  gutils library: https://github.com/bbugyi200/pylibs/tree/master/gutils                  #
############################################################################################

log = gutils.logging.getEasyLogger(__name__)


if __name__ == "__main__":
    parser = gutils.ArgumentParser()
    parser.add_argument('vargs', nargs='*', metavar=('arg'), default=50,
                        help='Number of minutes, offset from now, the next break will be set for.')
    args = parser.parse_args()

    with gutils.logging.context(log, debug=args.debug, verbose=args.verbose):
        try:
            vargs = list(args.vargs)
        except TypeError as e:
            vargs = []

        try:
            minutes = int(vargs[0])
        except (ValueError, IndexError) as e:
            minutes = 50
        else:
            vargs.pop(0)

        if vargs:
            event_name = ' '.join(vargs)
        else:
            event_name = 'START BREAK'

        log.vdebug('vargs: %s', repr(vargs))
        breaktime_dt = dt.datetime.now() + dt.timedelta(minutes=minutes)

        cmd_list = ['khal', 'new', '-a', 'daily']
        cmd_list.append(breaktime_dt.strftime('%Y-%m-%dT%H:%M'))
        cmd_list.append(event_name)
        sp.check_call(cmd_list)

        sp.Popen(['calalrms'], stdout=sp.DEVNULL, stderr=sp.STDOUT)
