#!/usr/bin/env python

""" Refresh window contents of the GTD tmux session """

import argparse
import subprocess as sp

mode_help = "Determines what information is refreshed. (Defaults to 'main')."
switch_help = "Switch to primary GTD window when done refreshing windows."
mode_opts = ['full', 'main', 'context']

parser = argparse.ArgumentParser(description=__doc__)
parser.add_argument('-S', '--switch', dest='switch', action='store_true', help=switch_help)
parser.add_argument('-M', '--mode', dest='mode', choices=mode_opts, default='main', help=mode_help)
args = parser.parse_args()


def send_keys(pane, keys):
    """ Run Pre-formatted 'tmux send-keys' Command """
    sp.call(['tmux', '-L', 'GTD', 'send-keys', '-t', 'GTD:{}.0'.format(pane), keys, 'Enter'])


if args.mode in ['full', 'context']:
    out = sp.check_output(['task', 'context', 'show']).decode('utf-8')
    if out.startswith('No'):
        current_context = 'NONE'
    else:
        temp = out.split()[1]
        current_context = temp.strip("'").upper()

    sp.call(['tmux', '-L', 'GTD', 'rename-window',
             '-t', 'GTD:0.0', current_context])

    send_keys(3, ':e')

if args.mode in ['full', 'main']:
    for pane, keys in [(0, 'tc'), (1, 'twc'), (2, 'kc')]:
        send_keys(pane, keys)

if args.switch:
    sp.call(['tmux', '-L', 'GTD', 'select-window', '-t', 'GTD:0.0'])
