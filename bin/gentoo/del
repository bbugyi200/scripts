#!/bin/bash

####################################################
#  Wrapper for `emerge` that Deletes a Package(s)  #
####################################################
# ---------- Functions ----------
function emsg() {
    MSG="$1"; shift
    echo ">>> $MSG"
}

# ---------- Command-line Arguments  ----------
eval set -- "$(getopt -o "d,D" -l "debug,depclean" -- "$@")"

while [[ -n "$1" ]]; do
    case $1 in
       -d|--debug )
           PS4='$LINENO: '
           set -x;;
       -D|--depclean )
           depclean=true
           ;;
       -- )
           shift
           break;;
    esac
    shift
done

# ---------- Main ----------
if [[ "$depclean" = true ]]; then
    OPTS=("--depclean" "--verbose")
else
    OPTS=("--unmerge")
fi

if sudo emerge --ask "${OPTS[@]}" "$@"; then
    for P in "$@"; do
        sed -i "\|$(ecat "$P")/$P|d" /etc/portage/sets/shared
    done

    emsg "Calling updatedb to update its databases."
    updatedb
else
    exit "$?"
fi
