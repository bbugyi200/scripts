#!/usr/bin/env python

""" Refresh window contents of the GTD tmux session """

import argparse
import subprocess as sp
import sys

full_help = "perform a full refresh"
context_help = "refresh context information only"

parser = argparse.ArgumentParser(description=__doc__)
parser.add_argument('-F', '--full', dest='full', action='store_true', help=full_help)
parser.add_argument('-C', '--context', dest='context', action='store_true', help=context_help)
args = parser.parse_args()


def send_keys(pane, keys):
    """ Run Pre-formatted 'tmux send-keys' Command """
    sp.call(['tmux', '-L', 'GTD', 'send-keys', '-t', 'GTD:{}.0'.format(pane), keys, 'Enter'])


if args.full or args.context:
    out = sp.check_output(['task', 'context', 'show']).decode('utf-8')
    if out.startswith('No'):
        current_context = 'NONE'
    else:
        temp = out.split()[1]
        current_context = temp.strip("'").upper()

    sp.call(['tmux', '-L', 'GTD', 'rename-window',
             '-t', 'GTD:0.0', current_context])

    send_keys(3, ':e')

if args.context:
    sys.exit(0)

for pane, keys in [(0, 'tc'), (1, 'twc'), (2, 'kc')]:
    send_keys(pane, keys)
